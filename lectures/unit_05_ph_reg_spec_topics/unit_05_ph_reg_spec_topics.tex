\PassOptionsToPackage{unicode=true}{hyperref} % options for packages loaded elsewhere
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames*,x11names*}{xcolor}
%
\documentclass[ignorenonframetext,]{beamer}
\setbeamertemplate{caption}[numbered]
\setbeamertemplate{caption label separator}{: }
\setbeamercolor{caption name}{fg=normal text.fg}
\beamertemplatenavigationsymbolsempty
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provides euro and other symbols
\else % if luatex or xelatex
  \usepackage{unicode-math}
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage[]{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\usepackage{xcolor}
\usepackage{hyperref}
\hypersetup{
            pdftitle={Proportional Hazards Regression: Special Topics},
            pdfauthor={Dave Harrington},
            colorlinks=true,
            linkcolor=darkblue,
            citecolor=darkblue,
            urlcolor=darkblue,
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\newif\ifbibliography
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Prevent slide breaks in the middle of a paragraph:
\widowpenalties 1 10000
\raggedbottom
\setbeamertemplate{part page}{
\centering
\begin{beamercolorbox}[sep=16pt,center]{part title}
  \usebeamerfont{part title}\insertpart\par
\end{beamercolorbox}
}
\setbeamertemplate{section page}{
\centering
\begin{beamercolorbox}[sep=12pt,center]{part title}
  \usebeamerfont{section title}\insertsection\par
\end{beamercolorbox}
}
\setbeamertemplate{subsection page}{
\centering
\begin{beamercolorbox}[sep=8pt,center]{part title}
  \usebeamerfont{subsection title}\insertsubsection\par
\end{beamercolorbox}
}
\AtBeginPart{
  \frame{\partpage}
}
\AtBeginSection{
  \ifbibliography
  \else
    \frame{\sectionpage}
  \fi
}
\AtBeginSubsection{
  \frame{\subsectionpage}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}

% set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother


\usepackage{amsmath,verbatim}

\usepackage{fancyvrb}
\usepackage{manfnt}
\usepackage[normalem]{ulem}

%\usepackage[colorlinks=true]{hyperref}

\mode<presentation>{\usetheme{Malmoe}}

%\synctex=1

\setbeamertemplate{headline}{}


\setbeamerfont{footline}{size=\scriptsize}
\setbeamerfont{frametitle}{shape=\scshape}
\setbeamertemplate{itemize items}[circle]
\setbeamercovered{transparent}

\setbeamertemplate{navigation symbols}{}
\setbeamertemplate{footline}[frame number]{} 


\definecolor{forest}{rgb}{0, .5, 0}
\definecolor{brick}{rgb}{.5, 0, 0}
\definecolor{darkgreen}{rgb}{0, .5, 0}
\definecolor{darkred}{rgb}{.7, .15, .15}
\definecolor{darkblue}{rgb}{0, 0, .5}
\definecolor{Green}{rgb}{0.2,1,0.2}


\newcommand{\R}{\textsf{R}}
\newcommand{\RStudio}{\textsl{R Studio}}
\newcommand{\var}{\mbox{Var}}
\newcommand{\Cov}{\mbox{Cov}}
\newcommand{\Cor}{\mbox{Cor}}
\newcommand{\cip}{\mbox{$\perp\!\!\!\perp$}}
\newcommand{\bpsi}{\mbox{\boldmath$\psi$}}
\newcommand{\bbeta}{\mbox{\boldmath$\beta$}}
\newcommand{\bhat}{\mbox{\boldmath$\hat\beta$}}
\newcommand{\btheta}{\mbox{\boldmath$\theta$}}
\newcommand{\beeta}{\mbox{\boldmath$\eta$}}
\newcommand{\bfeta}{\mbox{\boldmath$\eta$}}
\newcommand{\bpsinot}{\mbox{\boldmath{$\psi_0$}}}
\newcommand{\bZ}{\bf Z}

%\usepackage[english]{babel}
\usepackage{lmodern}
\renewcommand\ttfamily{\usefont{T1}{lmtt}{m}{n}}

%\usepackage{palatino}
\usepackage[T1]{fontenc}
%\usepackage[lmodern]{babel}

% make all tt fonts bold to look more like Verbatim
\renewcommand\ttfamily{\usefont{T1}{lmtt}{m}{n}}

% Comment these out if you don't want a slide with just the
% part/section/subsection/subsubsection title:
\AtBeginPart{
  \let\insertpartnumber\relax
  \let\partname\relax
  \frame{\partpage}
}
\AtBeginSection{
  \let\insertsectionnumber\relax
  \let\sectionname\relax
  \frame{\sectionpage}
}
\AtBeginSubsection{
  \let\insertsubsectionnumber\relax
  \let\subsectionname\relax
  \frame{\subsectionpage}
}

\begin{comment}

%reduces space between code chunk and output
\usepackage{etoolbox}
\setlength{\parskip}{0pt}
\setlength{\OuterFrameSep}{0pt}
\makeatletter
\preto{\@verbatim}{\topsep=-10pt \partopsep=10pt }
\makeatother

\end{comment}

\title{Proportional Hazards Regression: Special Topics}
\author{Dave Harrington}
\date{May 14 - 18, 2018}

\begin{document}
\frame{\titlepage}

\begin{frame}
\tableofcontents[hideallsubsections]
\end{frame}
\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

\begin{frame}{%
\protect\hypertarget{a-disclaimer}{%
A disclaimer}}

The topics in this unit are treated only briefly, and are intended to
serve as an introduction in a short course.

Each topic could be a substantial part of an advanced course on
regression and model fitting with the PH model.

See texts such as \emph{Therneau and Grambsch} or \emph{Klein and
Moeschberger}.

\end{frame}

\hypertarget{diagnostics-for-the-cox-model}{%
\section{Diagnostics for the Cox
model}\label{diagnostics-for-the-cox-model}}

\begin{frame}{%
\protect\hypertarget{types-of-model-diagnostics-for-cox-model}{%
Types of model diagnostics for Cox model}}

Simple plots for models with two groups

Graphical diagnostics based on residuals for larger models

Formal goodness-of-ft tests

\end{frame}

\begin{frame}{%
\protect\hypertarget{simple-plots-for-models-with-two-groups}{%
Simple plots for models with two groups}}

Suppose a covariate \(Z\) is coded 0, 1. In the \emph{PH} model, \[
\Lambda(t; Z = 1) = e^\beta \Lambda(t; Z = 0), \text{ so}
\]
\[ \log\left[\frac{\Lambda(t; Z = 1)}{\Lambda(t; Z = 0}\right] = \log(\Lambda(t; Z = 1)) - \log(\Lambda(t; Z = 0)) = \beta
\]

If the model is correct, then

\begin{itemize}
\item
  a simple plot of the difference of log cumulative hazard functions
  should be approximately constant
\item
  plots of the two log cumulative hazard functions should have the same
  separation
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{simple-plots-for-models-with-two-groups-1}{%
Simple plots for models with two groups \ldots}}

Since \[
  S(t) = \exp(-\Lambda(t)),
\] \[
\log(\Lambda(t)) = \log(-\log(S(t)))
\]

The plot of \(\log(-\log(S(t)))\) vs \(t\) is called the complementary
log-log survival
plot.\footnote{In \textsf{R}, the \texttt{"cloglog"} option in \texttt{survfit} plots $\log(-\log(S(t)))$ vs $\log(t)$.}

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{example-pbt01}{%
Example: PBT01}}

In a stratified model, the simple diagnostic plot should be done within
strata.

\scriptsize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(survival)}
\KeywordTok{library}\NormalTok{(eventtimedata)}
\KeywordTok{data}\NormalTok{(}\StringTok{"pbt01"}\NormalTok{)}
\NormalTok{cycle}\FloatTok{.1}\NormalTok{ =}\StringTok{ }\KeywordTok{subset}\NormalTok{(pbt01, cycle.of.resp }\OperatorTok{==}\StringTok{ "cycle.1"}\NormalTok{)}
\NormalTok{cycle.}\FloatTok{1.}\NormalTok{km =}\StringTok{ }\KeywordTok{survfit}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(survival,died) }\OperatorTok{~}\StringTok{ }\NormalTok{treatment, }\DataTypeTok{data=}\NormalTok{cycle}\FloatTok{.1}\NormalTok{)}

\KeywordTok{plot}\NormalTok{(cycle.}\FloatTok{1.}\NormalTok{km, }\DataTypeTok{fun =} \StringTok{"cloglog"}\NormalTok{, }\DataTypeTok{conf.int=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{lty =} \DecValTok{2}\OperatorTok{:}\DecValTok{3}\NormalTok{, }
     \DataTypeTok{axes=}\OtherTok{FALSE}\NormalTok{, }\DataTypeTok{col =} \DecValTok{3}\OperatorTok{:}\DecValTok{4}\NormalTok{, }\DataTypeTok{xlab=}\StringTok{"Months"}\NormalTok{, }\DataTypeTok{ylab=}\StringTok{"Log(-Log(Survival))"}\NormalTok{,}
     \DataTypeTok{main=}\StringTok{"Cycle.1 Strata"}\NormalTok{,}
     \DataTypeTok{cex =} \FloatTok{0.6}\NormalTok{, }
     \DataTypeTok{cex.main =} \FloatTok{0.8}\NormalTok{)}
\KeywordTok{axis}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\KeywordTok{axis}\NormalTok{(}\DecValTok{2}\NormalTok{)}
\KeywordTok{legend}\NormalTok{(}\StringTok{"bottomright"}\NormalTok{, }\DataTypeTok{lty=}\DecValTok{2}\OperatorTok{:}\DecValTok{3}\NormalTok{, }\DataTypeTok{col =} \DecValTok{3}\OperatorTok{:}\DecValTok{4}\NormalTok{, }\KeywordTok{c}\NormalTok{(}\StringTok{"AMBT"}\NormalTok{, }\StringTok{"Control"}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\end{frame}

\begin{frame}{%
\protect\hypertarget{pbt01-cycle.1-strata}{%
PBT01, cycle.1 strata}}

\scriptsize

\includegraphics{unit_05_ph_reg_spec_topics_files/figure-beamer/unnamed-chunk-2-1.pdf}

\end{frame}

\begin{frame}{%
\protect\hypertarget{pbt01-cycle.2-strata}{%
PBT01, cycle.2 strata}}

\scriptsize

\includegraphics{unit_05_ph_reg_spec_topics_files/figure-beamer/unnamed-chunk-3-1.pdf}

\end{frame}

\begin{frame}{%
\protect\hypertarget{more-diagnostics}{%
More diagnostics}}

Several types of residuals are used with the Cox PH model.

\begin{itemize}
\item
  Martingale residuals
\item
  Generalized (Cox-Snell) residuals
\item
  Schoenfeld and weighted Schoenfeld residuals
\item
  Scaled “dfbetas” residuals (approximate influence on parameter
  estimates from each case)
\end{itemize}

All of these are easily available in the \texttt{survival} package using
the \text{residuals()} after a PH fit, illustrated in the examples in
this unit.

\end{frame}

\begin{frame}{%
\protect\hypertarget{martingale-residuals-the-counting-process-approach}{%
Martingale residuals: The counting process approach}}

The martingale residuals arose from the counting process approach to
survival data.

Suppose

\begin{itemize}
\item
  \(X_i\) is the observed follow-up time for a case.
\item
  \(T_i\) is the underlying failure time.
\item
  \(U_i\) is the censoring time.
\item
  \(\delta_i = I\{T_i \leq U_i\}\) is the indicator for failure.
\item
  \(N_i(t) = I\{T_i \leq t, \delta_i = 1\}\)
\item
  \(Y_i(t) = I\{X_i \ge t\}\)
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{martingale-residuals-the-counting-process-approach-1}{%
Martingale residuals: The counting process approach\ldots}}

It turns out that \[
   M_i(t) = N_i(t) - \int_0^t Y_i(t) \exp[\bbeta {\bf Z}_i(t)] \lambda_0(u)du 
\] is a zero mean stochastic process with independent increments (i.e.,
a martingale).

The martingale residuals \(m_i\) are
\[m_i = \delta_i - \widehat{\Lambda}_i(T_i),\] where for case \(i\),

\begin{itemize}
\item
  \(\delta_i\) is the observed indicator of failure.
\item
  \(T_i\) is the observed follow-up time.
\item
  \(\widehat{\Lambda}_i\) is the estimated covariate specific cumulative
  hazard.
\end{itemize}

Martingale residuals are a form of \emph{observed - expected} and have
properties similar to residuals from linear models.

\end{frame}

\begin{frame}{%
\protect\hypertarget{properties-of-martingale-residuals}{%
Properties of martingale residuals}}

\begin{itemize}
\item
  \(E(m_i) = 0\)
\item
  \(\sum_{i=1}^n m_i = 0\)
\item
  \(\text{var}(m_i) \approx E_i = \Lambda_i(X_i)\)
\item
  \(\text{cov}(m_i, m_j) \approx 0\). Since the residuals must sum to
  zero there is a small negative correlation.
\end{itemize}

A bit more surprising:

Assume one dimensional covariate, and that the true model is \[
        \lambda_i(t) = \lambda_0(t) e^{f(Z_i)}.
\]

Then it can be shown that \[
   E(m_i) \approx c f(Z_i) \,
\] where the constant \(c\) depends on the amount of censoring.
(Therneau, Grambsch, and Fleming, 1990)

\end{frame}

\begin{frame}{%
\protect\hypertarget{properties-of-martingale-residuals-1}{%
Properties of martingale residuals\ldots}}

Implications of the last slide:

\begin{itemize}
\tightlist
\item
  A scatterplot of \(Z\) versus \(m\) should suggest the functional form
  of the covariate \(f\), since \(c\) will only affect the scale
  (labeling) of the vertical axis of the plot.
\end{itemize}

These are not as easy to interpret as residuals from linear models since
the \(m_i\) are skewed and do not have constant variance.

\begin{itemize}
\item
  Martingale residuals are calculated using

  \begin{itemize}
  \tightlist
  \item
    \texttt{residuals(phmodel), type = "martingale"}, where
    \texttt{phmodel} is defined as the \texttt{coxph()} model fit.
  \end{itemize}
\item
  It is customary to add a LOESS curve to the plot.
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{null-model-vs.partial-residuals}{%
Null model vs.~partial residuals}}

Martingale residuals can be calculated

\begin{itemize}
\item
  in a null model with no covariates,

  \begin{itemize}
  \tightlist
  \item
    This is the analogue of a scatterplot in regression before model
    estimation.
  \end{itemize}
\item
  or in a model with covariates to examine possible transformations
  after an initial model.
\end{itemize}

As in linear regression, there are advantages and disadvantages to
either approach.

Null models are fit using \texttt{coxph(Surv() \char`~ \ 1)}.

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{null-model-residuals-against-age-in-the-rossi-data}{%
Null model residuals against age in the Rossi data}}

\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(survival)}
\KeywordTok{library}\NormalTok{(eventtimedata)}
\KeywordTok{data}\NormalTok{(rossi)}
\NormalTok{rossi.phmodel =}\StringTok{ }\KeywordTok{coxph}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(week, arrest) }\OperatorTok{~}\StringTok{ }\DecValTok{1}\NormalTok{, }\DataTypeTok{data =}\NormalTok{ rossi)}
\NormalTok{mart.resid =}\StringTok{ }\KeywordTok{residuals}\NormalTok{(rossi.phmodel, }\DataTypeTok{type =} \StringTok{"martingale"}\NormalTok{)}
\KeywordTok{plot}\NormalTok{(rossi}\OperatorTok{$}\NormalTok{age, mart.resid)}
\KeywordTok{lines}\NormalTok{(}\KeywordTok{lowess}\NormalTok{(rossi}\OperatorTok{$}\NormalTok{age, mart.resid), }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{unit_05_ph_reg_spec_topics_files/figure-beamer/unnamed-chunk-4-1.pdf}

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{partial-martingale-residuals-against-age-in-the-rossi-data}{%
Partial martingale residuals against age in the Rossi data}}

\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(survival)}
\KeywordTok{library}\NormalTok{(eventtimedata)}
\KeywordTok{data}\NormalTok{(rossi)}
\NormalTok{rossi.phmodel =}\StringTok{ }\KeywordTok{coxph}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(week, arrest) }\OperatorTok{~}\StringTok{ }\NormalTok{fin }\OperatorTok{+}\StringTok{ }\NormalTok{age }\OperatorTok{+}\StringTok{ }\NormalTok{race }\OperatorTok{+}\StringTok{ }\NormalTok{mar, }
                      \DataTypeTok{data =}\NormalTok{ rossi)}
\NormalTok{mart.resid =}\StringTok{ }\KeywordTok{residuals}\NormalTok{(rossi.phmodel, }\DataTypeTok{type=}\StringTok{"martingale"}\NormalTok{)}
\KeywordTok{plot}\NormalTok{(rossi}\OperatorTok{$}\NormalTok{age, mart.resid)}
\KeywordTok{lines}\NormalTok{(}\KeywordTok{lowess}\NormalTok{(rossi}\OperatorTok{$}\NormalTok{age, mart.resid), }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\end{frame}

\begin{frame}{%
\protect\hypertarget{partial-martingale-residuals-against-age-in-the-rossi-data-1}{%
Partial martingale residuals against age in the Rossi data}}

\footnotesize

\includegraphics{unit_05_ph_reg_spec_topics_files/figure-beamer/unnamed-chunk-6-1.pdf}

Except for younger ages, there is no evident transformation.

In the null model, what causes the line of residuals just below
\(y = -0.2\)? (Lab question)

\end{frame}

\begin{frame}{%
\protect\hypertarget{cox-snell-residuals-background}{%
Cox-Snell residuals: background}}

If \(T_i\) (the survival time for the \(i\)-th individual) has
survivorship function \(S_i(t)\), then

\begin{itemize}
\item
  the transformed random variable \(S_i(T_i)\) will have a uniform
  distribution on \([0,1]\),
\item
  and \(-\log[S_i(T_i)]\) should be from a unit exponential
  distribution.
\end{itemize}

More mathematically stated: \begin{align*}
\mbox{If ~~} T_i  &\sim S_i(t)\\
\mbox{then}~~ S_i(T_i) &\sim  \text{Uniform}[0,1]\\
\mbox{and}~ -\log S_i(T_i) &\sim \text{Exponential}(1)
\end{align*}

Proof in the labs.

\end{frame}

\begin{frame}{%
\protect\hypertarget{generalized-cox-snell-residuals}{%
Generalized (Cox-Snell) residuals}}

The implication of the last result:

\begin{itemize}
\item
  If the model is correct, the estimated cumulative hazard for each
  individual at the time of death or censoring should behave like a
  censored sample from a unit exponential.
\item
  This quantity, \(\widehat{\Lambda}_i\), is called the
  \emph{generalized} or \emph{Cox-Snell} residual.
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{calculating-the-cox-snell-residuals-in-r}{%
Calculating the Cox-Snell residuals in R}}

Not difficult to program \textsf{R} to program and plot the Cox-Snell
residuals, but not necessary.

Recall the \emph{martingale} residuals
\[m_i = \delta_i - \widehat{\Lambda}_i(T_i),\] where for case \(i\),
when there are no time-dependent covariates,
\[cs_i = \delta_i - m_i = \widehat{\Lambda}_i(T_i) \]

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{cox-snell-residuals-in-the-rossi-data}{%
Cox-Snell residuals in the Rossi data}}

\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(survival)}
\KeywordTok{library}\NormalTok{(eventtimedata)}
\KeywordTok{data}\NormalTok{(rossi)}
\NormalTok{rossi.phmodel =}\StringTok{ }\KeywordTok{coxph}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(week, arrest) }\OperatorTok{~}\StringTok{ }\NormalTok{fin }\OperatorTok{+}\StringTok{ }\NormalTok{age }\OperatorTok{+}\StringTok{ }\NormalTok{race }\OperatorTok{+}\StringTok{ }\NormalTok{mar, }
                      \DataTypeTok{data =}\NormalTok{ rossi)}
\NormalTok{mart.resid =}\StringTok{ }\KeywordTok{residuals}\NormalTok{(rossi.phmodel, }\DataTypeTok{type=}\StringTok{"martingale"}\NormalTok{)}
\NormalTok{cs.resid =}\StringTok{ }\NormalTok{rossi}\OperatorTok{$}\NormalTok{arrest }\OperatorTok{-}\StringTok{ }\NormalTok{mart.resid}
\NormalTok{cs.surv =}\StringTok{ }\KeywordTok{survfit}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(cs.resid, rossi}\OperatorTok{$}\NormalTok{arrest) }\OperatorTok{~}\StringTok{ }\DecValTok{1}\NormalTok{, }
                               \DataTypeTok{type =} \StringTok{"fleming-harrington"}\NormalTok{)}
\KeywordTok{plot}\NormalTok{(cs.surv}\OperatorTok{$}\NormalTok{time, }\OperatorTok{-}\KeywordTok{log}\NormalTok{(cs.surv}\OperatorTok{$}\NormalTok{surv))}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{a =} \DecValTok{0}\NormalTok{, }\DataTypeTok{b =} \DecValTok{1}\NormalTok{, }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\end{frame}

\begin{frame}{%
\protect\hypertarget{cox-snell-residuals-in-the-rossi-data-1}{%
Cox-Snell residuals in the Rossi data}}

\includegraphics{unit_05_ph_reg_spec_topics_files/figure-beamer/unnamed-chunk-8-1.pdf}

\end{frame}

\begin{frame}{%
\protect\hypertarget{cox-snell-residuals}{%
Cox-Snell residuals \ldots}}

The Cox-Snell residuals are theoretically appealing because the notion
shows up more generally in non-linear models.

However, they are not widely used because they do not help diagnose
reasons for an ill-fitting model.

The martingale and Schoenfeld residuals are more practially useful.

\end{frame}

\begin{frame}{%
\protect\hypertarget{schoenfeld-residuals-testing-the-ph-assumption}{%
Schoenfeld residuals: testing the PH assumption}}

The \textsf{R} function \texttt{cox.zph} provides a \(p\)-value for a
test of the hypothesis that PH is the right model, as well as plots.

\begin{itemize}
\item
  The plots show \emph{scaled Schoenfeld residuals} for each covariate,
  plotted against time.
\item
  Under \emph{PH}, the smoothing line should be approximately
  horizontal.
\item
  These have become more popular than either the Cox-Snell or martingale
  residuals.
\end{itemize}

Derivation not shown here, application on the next slide.

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{schoenfield-residuals-in-the-rossi-data}{%
Schoenfield residuals in the Rossi data}}

\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(survival)}
\KeywordTok{library}\NormalTok{(eventtimedata)}
\KeywordTok{data}\NormalTok{(rossi)}
\NormalTok{rossi.phmodel =}\StringTok{ }\KeywordTok{coxph}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(week, arrest) }\OperatorTok{~}\StringTok{ }\NormalTok{fin }\OperatorTok{+}\StringTok{ }\NormalTok{age }\OperatorTok{+}\StringTok{ }\NormalTok{race }\OperatorTok{+}\StringTok{ }\NormalTok{mar, }
                      \DataTypeTok{data =}\NormalTok{ rossi)}
\NormalTok{rossi.zph =}\StringTok{ }\KeywordTok{cox.zph}\NormalTok{(rossi.phmodel)}
\NormalTok{rossi.zph}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##                    rho   chisq       p
## finyes          0.0088 0.00899 0.92446
## age            -0.2131 6.97001 0.00829
## raceother       0.1230 1.71919 0.18980
## marnot married -0.1301 2.05051 0.15215
## GLOBAL              NA 9.83392 0.04332
\end{verbatim}

\end{frame}

\begin{frame}{%
\protect\hypertarget{schoenfield-residuals-in-the-rossi-data-1}{%
Schoenfield residuals in the Rossi data}}

\small

\includegraphics{unit_05_ph_reg_spec_topics_files/figure-beamer/unnamed-chunk-10-1.pdf}

\end{frame}

\begin{frame}{%
\protect\hypertarget{dfbeta-residuals}{%
dfbeta residuals}}

In an estimated linear model \(y = {\bf X}{\bf b} + e\), it is easy to
calculate the approximate change in the estimated coefficients
\({\bf b} - {\bf b}_{-i}\) if case \(i\) is dropped, using the \emph{hat
matrix}.

\begin{itemize}
\item
  These changes are often referred to as \emph{dfbeta} residuals and
  help identify cases with high \emph{leverage}.
\item
  A similar (approximate) calculation can be done for the PH model using
  changes in the score function if a case is dropped (details not shown
  here).
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{dfbeta-residuals-1}{%
dfbeta residuals \ldots}}

The \texttt{residuals()} function used on a PH model fit can be used to
calculate two versions of dfbeta residuals:

\begin{itemize}
\item
  \texttt{dfbeta}: changes in the estimated coefficients

  \begin{itemize}
  \tightlist
  \item
    easier to see true influence
  \end{itemize}
\item
  \texttt{dfbetas}: changes in estimated coefficients divided by their
  standard errors

  \begin{itemize}
  \tightlist
  \item
    easier to detect `large changes’, since these can be thought of as
    approximately \(N(0,1)\)
  \end{itemize}
\end{itemize}

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{unstandardized-dfbeta-residuals-for-age-in-the-rossi-data}{%
Unstandardized dfbeta residuals for age in the rossi data}}

\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(survival)}
\KeywordTok{library}\NormalTok{(eventtimedata)}
\KeywordTok{data}\NormalTok{(rossi)}

\NormalTok{rossi.phmodel =}\StringTok{ }\KeywordTok{coxph}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(week, arrest) }\OperatorTok{~}\StringTok{ }\NormalTok{fin }\OperatorTok{+}\StringTok{ }\NormalTok{age }\OperatorTok{+}\StringTok{ }\NormalTok{race }\OperatorTok{+}\StringTok{ }\NormalTok{mar, }
                      \DataTypeTok{data =}\NormalTok{ rossi)}
\NormalTok{unstand.dfbeta =}\StringTok{ }\KeywordTok{residuals}\NormalTok{(rossi.phmodel, }\DataTypeTok{type =} \StringTok{"dfbeta"}\NormalTok{)}
\NormalTok{rossi}\OperatorTok{$}\NormalTok{caseid =}\StringTok{ }\DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(rossi}\OperatorTok{$}\NormalTok{age)}
\KeywordTok{colnames}\NormalTok{(unstand.dfbeta) =}\StringTok{ }\KeywordTok{names}\NormalTok{(rossi.phmodel}\OperatorTok{$}\NormalTok{coef)}

\KeywordTok{plot}\NormalTok{(rossi}\OperatorTok{$}\NormalTok{caseid, unstand.dfbeta[, }\StringTok{"age"}\NormalTok{], }\DataTypeTok{xlab =} \StringTok{"case id"}\NormalTok{,}
     \DataTypeTok{ylab =} \StringTok{"age delta - beta"}\NormalTok{, }\DataTypeTok{cex =} \FloatTok{0.5}\NormalTok{)}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{h =} \DecValTok{0}\NormalTok{, }\DataTypeTok{lty =} \DecValTok{2}\NormalTok{, col }\StringTok{"red"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\end{frame}

\begin{frame}{%
\protect\hypertarget{unstandardized-dfbeta-residuals-for-age-in-the-rossi-data-1}{%
Unstandardized dfbeta residuals for age in the rossi data}}

\includegraphics{unit_05_ph_reg_spec_topics_files/figure-beamer/unnamed-chunk-12-1.pdf}

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{standardized-dfbeta-residuals-for-age-in-the-rossi-data}{%
Standardized dfbeta residuals for age in the rossi data}}

\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(survival)}
\KeywordTok{library}\NormalTok{(eventtimedata)}
\KeywordTok{data}\NormalTok{(rossi)}
\NormalTok{rossi.phmodel =}\StringTok{ }\KeywordTok{coxph}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(week, arrest) }\OperatorTok{~}\StringTok{ }\NormalTok{fin }\OperatorTok{+}\StringTok{ }\NormalTok{age }\OperatorTok{+}\StringTok{ }\NormalTok{race }\OperatorTok{+}\StringTok{ }\NormalTok{mar, }
                      \DataTypeTok{data =}\NormalTok{ rossi)}
\NormalTok{stand.dfbeta =}\StringTok{ }\KeywordTok{residuals}\NormalTok{(rossi.phmodel, }\DataTypeTok{type =} \StringTok{"dfbetas"}\NormalTok{)}
\NormalTok{rossi}\OperatorTok{$}\NormalTok{caseid =}\StringTok{ }\DecValTok{1}\OperatorTok{:}\KeywordTok{length}\NormalTok{(rossi}\OperatorTok{$}\NormalTok{age)}
\KeywordTok{colnames}\NormalTok{(stand.dfbeta) =}\StringTok{ }\KeywordTok{names}\NormalTok{(rossi.phmodel}\OperatorTok{$}\NormalTok{coef)}

\KeywordTok{plot}\NormalTok{(rossi}\OperatorTok{$}\NormalTok{caseid, stand.dfbeta[,}\DecValTok{2}\NormalTok{], }\DataTypeTok{xlab =} \StringTok{"case id"}\NormalTok{,}
     \DataTypeTok{ylab =} \StringTok{"age delta - beta"}\NormalTok{, }\DataTypeTok{cex =} \FloatTok{0.5}\NormalTok{)}
\KeywordTok{abline}\NormalTok{(}\DataTypeTok{h =} \DecValTok{0}\NormalTok{, }\DataTypeTok{lty =} \DecValTok{2}\NormalTok{, }\DataTypeTok{col =} \StringTok{"red"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\end{frame}

\begin{frame}{%
\protect\hypertarget{standardized-dfbeta-residuals-for-age-in-the-rossi-data-1}{%
Standardized dfbeta residuals for age in the rossi data}}

\includegraphics{unit_05_ph_reg_spec_topics_files/figure-beamer/unnamed-chunk-14-1.pdf}

\end{frame}

\hypertarget{correlated-event-times}{%
\section{Correlated event times}\label{correlated-event-times}}

\begin{frame}{%
\protect\hypertarget{causes-of-correlated-failure-time-data}{%
Causes of correlated failure time data}}

\begin{itemize}
\item
  Natural clustering of subjects in families, villages, treatment
  centers
\item
  Shared unmeasured covariates
\item
  Multiple event times from individual subjects
\end{itemize}

We begin with a dataset\ldots{}

\end{frame}

\begin{frame}{%
\protect\hypertarget{diabetic-retinopathy-study-drs}{%
Diabetic Retinopathy Study (DRS)}}

Diabetic retinopathy

\begin{itemize}
\item
  Complication associated with diabetes mellitus
\item
  Abnormalities in the microvasculature within eye retina.
\item
  Leading cause of new cases of blindness in patients under 60 years of
  age in US
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{diabetic-retinopathy-study-drs-1}{%
Diabetic Retinopathy Study (DRS)\ldots}}

DRS begun in 1971 to study effectiveness of laser therapy in delaying
onset of blindness.

\begin{itemize}
\item
  Eligible patients had DR and visual acuity of 20/100 or better
\item
  One eye of each patient randomly selected for therapy; other eye
  observed without therapy
\item
  Main endpoint: visual acuity less than 5/200 at two consecutive
  4-month follow-ups
\item
  1,742 patients registered for the
  study.\footnote{Study originally reported in Murphy and Patz (1978).}
\item
  Subset used here consists of 197 patients that make up a 50\%
  subsample of high-risk patients as defined in the
  study.\footnote{These 197 patients analyzed in \href{run:../../methods_papers/Huster\_drs.pdf}{Huster, 1989}. Data in \texttt{drs} dataset in \texttt{eventtimedata} package.}
\end{itemize}

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{the-first-8-records}{%
The first 8 records}}

\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(survival)}
\KeywordTok{library}\NormalTok{(eventtimedata)}
\KeywordTok{data}\NormalTok{(drs)}
\NormalTok{drs[}\DecValTok{1}\OperatorTok{:}\DecValTok{8}\NormalTok{,]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   id obstime fail           age      tx
## 1  5   46.23    0 older than 20   laser
## 2  5   46.23    0 older than 20 control
## 3 14   42.50    0 20 or younger   laser
## 4 14   31.30    1 20 or younger control
## 5 16   42.27    0 20 or younger   laser
## 6 16   42.27    0 20 or younger control
## 7 25   20.60    0 20 or younger   laser
## 8 25   20.60    0 20 or younger control
\end{verbatim}

\end{frame}

\begin{frame}{%
\protect\hypertarget{some-features-of-the-data}{%
Some features of the data}}

Some important features of this dataset:

\begin{itemize}
\item
  Strong intra-pair (within-person) correlation
\item
  No natural ordering of event times within the pairs
\end{itemize}

Two ways to think about capturing the effect:

\begin{itemize}
\item
  \emph{Marginal Model}: estimating the `average’, or population effect
  of treatment, at least for the population represented by these cases
\item
  \emph{Conditional Model}: estimating subject-specific effect (i.e.,
  the within-subject difference in outcomes for the two eyes),
  conditional on some possible unobserved subject effect
\end{itemize}

\end{frame}

\hypertarget{marginal-models-for-correlated-event-times}{%
\section{Marginal models for correlated event
times}\label{marginal-models-for-correlated-event-times}}

\begin{frame}{%
\protect\hypertarget{background-on-marginal-models}{%
Background on marginal models}}

Approach is a natural extension of generalized estimating equations used
with correlated longitudinal data.

\begin{itemize}
\item
  Most popular method due to
  \href{../../methods_papers/wlw.pdf}{\textcolor{darkblue}{Wei, Lin, and Weissfeld, 1989}}
  (\emph{WLW}).
\item
  \emph{DRS} is a good concrete example to keep in mind.
\end{itemize}

Main ideas

\begin{itemize}
\item
  Assume \(K\) different possibly correlated failure times,
  \((T_1,\ldots, T_K)\).
\item
  In general, there would be a joint survivor function \[
        S(t_1, \ldots, t_K \mid {\bf Z}) 
            = \Pr (T_1 > t_1,\dots,T_K > t_K \mid {\bf Z})
    \] depending on a covariate vector \({\bf Z}\).
\item
  General approach of modeling and estimating \(S\) difficult. The most
  progress has been made with parametric models.
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{marginal-approach}{%
Marginal approach}}

\begin{itemize}
\item
  Specify a model for marginal survivor function of \(T_k\), \[  
        S_k(t_k \mid \bZ_k^\prime),
    \] where \(\bZ_k^\prime = (Z_{1k},\dots,Z_{pk})\) is a
  \(p\)-dimensional covariate vector associated with failure type \(k\).
\item
  Estimate the \(S_k\)’s (or at least the effect of \(\bZ_k\) on
  \(S_k\)) as if \(T_1, \dots, T_K\) are independent.
\item
  Establish (through some general theory) that \(\widehat{S}_k\) (or
  estimated regression effect) is unbiased.
\item
  Compute a `corrected’ variance estimate for any estimated parameters
  that will account for the dependence among failure types.
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{marginal-model-with-the-cox-model}{%
Marginal model with the Cox model}}

Marginal proportional hazards model of \emph{WLW}:

\begin{itemize}
\item
  Model hazard of \(T_k\) as \[
        \lambda_0(t) \exp(\bbeta^\prime \bZ_k) \mbox{ or } 
        \lambda_{0k}(t) \exp(\bbeta^\prime \bZ_k)
    \]
\item
  Construct partial likelihood function which assumes that failure types
  define independent subgroups or \emph{strata}.
\item
  Compute a robust estimate of the \(\mbox{cov}(\widehat{\bbeta})\),
  using a usual sandwich type estimator.
\end{itemize}

Details coming later\ldots

\end{frame}

\begin{frame}{%
\protect\hypertarget{notation-in-the-drs-data}{%
Notation in the DRS data}}

\begin{itemize}
\item
  \(T_1\) denotes failure time for left eye, \(T_2\) for right eye
\item
  \(\lambda_{01}(t) = \lambda_{02}(t) = \lambda_0(t)\)
\item
  \(\bZ_k^\prime\) = (treatment, age at onset) = \((Z_{1k},Z_{2k})\)
\item
  It is natural to assume no biological difference between eyes, but if
  that were not the case, one could stratify on eye type or add a third
  covariate that denoted eye type.
\item
  Treatment by eye type interactions would allow for different treatment
  effects by eye type.
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{structure-of-the-drs-dataset}{%
Structure of the DRS dataset}}

Datasets fit with WLW usually take one of two forms

\begin{itemize}
\item
  Paired data, with no obvious way to distinguish between members of the
  pair (at least from the data)
\item
  Several identified failure types within an individual that are used to
  create strata, with a strata denoting a particular failure type.
\end{itemize}

The \texttt{drs} dataset is of the first type.

\begin{itemize}
\item
  Fit an unstratified model, assuming same baseline failure for each
  eye.
\item
  Calculate a robust variance to account for the within-pair
  correlation, using the \texttt{cluster} term in the model.
\end{itemize}

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{marginal-model-in-the-drs-data}{%
Marginal model in the DRS data}}

\scriptsize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(survival)}
\KeywordTok{library}\NormalTok{(eventtimedata)}
\KeywordTok{data}\NormalTok{(drs)}

\KeywordTok{coxph}\NormalTok{(}\DataTypeTok{formula =} \KeywordTok{Surv}\NormalTok{(obstime, fail) }\OperatorTok{~}\StringTok{ }\NormalTok{tx }\OperatorTok{+}\StringTok{ }\NormalTok{age }\OperatorTok{+}\StringTok{ }\KeywordTok{cluster}\NormalTok{(id),}
      \DataTypeTok{data =}\NormalTok{ drs)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Call:
## coxph(formula = Surv(obstime, fail) ~ tx + age + cluster(id), 
##     data = drs)
## 
##                     coef exp(coef) se(coef) robust se     z       p
## txlaser          -0.7789    0.4589   0.1689    0.1485 -5.25 1.6e-07
## ageolder than 20  0.0539    1.0554   0.1621    0.1786  0.30    0.76
## 
## Likelihood ratio test=22.5  on 2 df, p=1.31e-05
## n= 394, number of events= 155
\end{verbatim}

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{the-role-of-age-in-the-drs}{%
The role of age in the drs}}

Confounding should be minimized in a randomized trial.

\begin{itemize}
\tightlist
\item
  This can be assessed with a marginal model that includes only
  treatment.
\end{itemize}

\scriptsize

\begin{verbatim}
## Call:
## coxph(formula = Surv(obstime, fail) ~ tx + cluster(id), data = drs)
## 
##           coef exp(coef) se(coef) robust se     z       p
## txlaser -0.777     0.460    0.169     0.147 -5.27 1.4e-07
## 
## Likelihood ratio test=22.4  on 1 df, p=2.25e-06
## n= 394, number of events= 155
\end{verbatim}

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{what-about-an-age-by-treatment-interaction}{%
What about an age by treatment interaction?}}

Randomized trials do not preclude interaction effects.

\begin{itemize}
\tightlist
\item
  One might suspect that the treatment acts differently on younger
  versus older participants.
\end{itemize}

\scriptsize

\begin{verbatim}
## Call:
## coxph(formula = Surv(obstime, fail) ~ tx * age + cluster(id), 
##     data = drs)
## 
##                            coef exp(coef) se(coef) robust se     z      p
## txlaser                  -0.425     0.654    0.218     0.185 -2.30 0.0216
## ageolder than 20          0.341     1.407    0.199     0.196  1.74 0.0813
## txlaser:ageolder than 20 -0.846     0.429    0.351     0.304 -2.79 0.0053
## 
## Likelihood ratio test=28.5  on 3 df, p=2.87e-06
## n= 394, number of events= 155
\end{verbatim}

\end{frame}

\begin{frame}{%
\protect\hypertarget{some-consequences-of-this-modeling-strategy}{%
Some consequences of this modeling strategy}}

Need not specify correlation structure among failure types.

Does not exploit correlation structure that may be evident in some data.

Requires that each observational unit (usually subject) have same number
of failure types.

Some failure types may produce dependent censoring for other types.

\begin{itemize}
\tightlist
\item
  Why might that happen?
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{the-robust-variance-estimator}{%
The robust variance estimator}}

The robust variance is based on a ``sandwich’’ estimate \[
   V = {\cal I}^{-1} B {\cal I}^{-1},
\] where

\begin{itemize}
\tightlist
\item
  \({\cal I}^{-1}\) is the usual variance estimate of a Cox model, the
  inverse of the information matrix \({\cal I}\).
\item
  \(B\) is a correction factor.
\end{itemize}

This form of a variance estimate is widely used with generalized
estimating equations and has been variously named

\begin{itemize}
\tightlist
\item
  Huber sandwich estimator\\
\item
  White’s estimate
\item
  Horvitz-Thompson estimator\\
\item
  Infinitesimal or approximate jacknife
\item
  WLE estimate
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{robust-variance-estimate-in-the-cox-model}{%
Robust variance estimate in the Cox model}}

For a Cox model, the \emph{WLW} estimator becomes, after some
calculations, \(D^\prime D\), where \(D\) is the matrix of \emph{dfbeta}
residuals from \texttt{coxph}.

The robust variance estimate is (essentially) a jackknife estimate of
the covariance of the coefficient estimates.

The jackknife statistic was one of the early versions of `bootstrap’
estimates of variance calculated through resampling.

The robust variance estimate is approximate, since the dfbeta residuals
are approximate changes in coefficients when cases are dropped.

\end{frame}

\hypertarget{conditional-frailty-models-for-correlated-event-times}{%
\section{Conditional (Frailty) models for correlated event
times}\label{conditional-frailty-models-for-correlated-event-times}}

\begin{frame}{%
\protect\hypertarget{frailty-models}{%
Frailty models}}

Suppose data is made up of \(J\) clusters, and that the \(j^{th}\)
cluster has \(n_j\) members.

Assume that conditional on an unobservable variable \(\psi_j\) in
cluster \(j\), the failure times within a cluster are independent with
hazard \[
        \lambda_j(t \mid \bZ_j) = \psi_j \lambda_0(t)
        \exp(\bbeta^\prime \bZ_j).
    \] \(\psi\) is called the frailty term.

Assume that the cluster-specific frailties \(\psi_j (j = 1,\dots,J)\)
are independent and identically distributed, and that failure times in
different clusters are independent.

\end{frame}

\begin{frame}{%
\protect\hypertarget{estimation-for-frailty-models}{%
Estimation for frailty models}}

Specify the marginal distribution for \(\psi\).

\begin{itemize}
\item
  Gamma frailty – Clayton (1978)
\item
  Positive stable frailty – Hougaard (1986a, 1986b, 1987)
\item
  Lognormal – McGilchrist and Aisbett (1991)
\end{itemize}

Write down joint likelihood for \((T, \psi)\) as \([T | \psi] [\psi]\),
then integrate out \(\psi\). More later on other ways to do this.

Estimation strategy outlined above suggests that one must have a
parametric model for \(T\), but \texttt{coxph} can also incorporate
frailty terms.

Parametric frailty models can be fit using \texttt{survreg} in the
\texttt{survival} package, or the more extensive package \texttt{parfm}.

\end{frame}

\begin{frame}{%
\protect\hypertarget{consequences-of-the-frailty-models}{%
Consequences of the frailty models}}

Intellectually appealing.

Closely related to stratified models.

Regression parameter \(\bbeta\) must be interpreted only within
clusters.

\begin{itemize}
\item
  In fact, PH model must be interpreted within cluster.
\item
  Theory shows that only the positive stable frailty distributions lead
  to marginal proportional hazards model.
\end{itemize}

Computational problems are substantial, but progress is being made.

For cluster size \(>\) 2, basic model \(\longrightarrow\) symmetric
correlation structure. Work has been done to relax that.

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{adding-frailty-terms-to-coxph-with-drs}{%
Adding frailty terms to coxph with drs}}

\scriptsize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(survival)}
\KeywordTok{library}\NormalTok{(eventtimedata)}
\KeywordTok{data}\NormalTok{(drs)}

\KeywordTok{coxph}\NormalTok{(}\DataTypeTok{formula =} \KeywordTok{Surv}\NormalTok{(obstime, fail) }\OperatorTok{~}\StringTok{ }\NormalTok{tx }\OperatorTok{+}\StringTok{ }\NormalTok{age }\OperatorTok{+}\StringTok{ }
\StringTok{        }\KeywordTok{frailty}\NormalTok{(id, }\DataTypeTok{distribution =} \StringTok{"gamma"}\NormalTok{), }\DataTypeTok{data =}\NormalTok{ drs)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Call:
## coxph(formula = Surv(obstime, fail) ~ tx + age + frailty(id, 
##     distribution = "gamma"), data = drs)
## 
##                               coef se(coef)      se2    Chisq DF       p
## txlaser                    -0.9111   0.1744   0.1712  27.3081  1 1.7e-07
## ageolder than 20            0.0410   0.2207   0.1657   0.0345  1   0.853
## frailty(id, distribution                             113.8026 84   0.017
## 
## Iterations: 6 outer, 30 Newton-Raphson
##      Variance of random effect= 0.851   I-likelihood = -850.8 
## Degrees of freedom for terms=  1.0  0.6 84.0 
## Likelihood ratio test=201  on 85.6 df, p=2.77e-11  n= 394
\end{verbatim}

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{what-about-the-age-by-treatment-interaction-examined-earlier}{%
What about the age by treatment interaction examined earlier?}}

\scriptsize

\begin{verbatim}
## Call:
## coxph(formula = Surv(obstime, fail) ~ tx * age + frailty(id, 
##     distribution = "gamma"), data = drs)
## 
##                              coef se(coef)     se2   Chisq   DF      p
## txlaser                    -0.506    0.225   0.221   5.034  1.0 0.0248
## ageolder than 20            0.397    0.259   0.205   2.346  1.0 0.1256
## frailty(id, distribution                           122.555 88.6 0.0098
## txlaser:ageolder than 20   -0.985    0.362   0.355   7.414  1.0 0.0065
## 
## Iterations: 6 outer, 31 Newton-Raphson
##      Variance of random effect= 0.926   I-likelihood = -847 
## Degrees of freedom for terms=  1.0  0.6 88.6  1.0 
## Likelihood ratio test=218  on 91.1 df, p=1.86e-12  n= 394
\end{verbatim}

\end{frame}

\hypertarget{models-for-repeated-events}{%
\section{Models for repeated events}\label{models-for-repeated-events}}

\begin{frame}{%
\protect\hypertarget{introduction-1}{%
Introduction}}

Correlated failure time data may arise in repeated event data.

\begin{itemize}
\tightlist
\item
  In \texttt{drs}, the correlated failure times were measured on
  separate eyes and both measured from time 0.
\end{itemize}

Perhaps best illustrated with the \texttt{cgd} dataset in the
\texttt{survival} package.

CGD is a heterogeneous group of rare inherited disorders characterized
by recurrent infections beginning in childhood.

\end{frame}

\begin{frame}{%
\protect\hypertarget{cgd-dataset}{%
CGD dataset}}

Data from 1986 trial conducted by International CGD Study
Group.\footnote{
Data appears in Appendix D.2 of Fleming and Harrington.}

\begin{itemize}
\item
  Randomized, double-blind trial comparing placebo with recombinant
  \(\gamma\) interferon (rIFN-g), each administered 3 times daily for a
  year.
\item
  128 patients: 65 on placebo, 63 on rIFN-g.
\item
  Primary outcome: time to first serious infection.
\item
  Data collected on all serious infections until the end of follow-up,
  400 days or less for nearly all patients.
\item
  Trial reported in \emph{NEJM} (1991) \textbf{324: 509-516}.
\end{itemize}

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{cgd-dataset-1}{%
CGD dataset\ldots}}

Data appears in two formats in the package \texttt{survival}.

The dataset \texttt{cgd0} is the data as collected and as it appears in
Fleming and Harrington.

\footnotesize

\begin{verbatim}
## Warning in data("cgd0"): data set 'cgd0' not found
\end{verbatim}

\begin{verbatim}
##   id treat age futime etime1 etime2 etime3
## 1  1     1  12    414    219    373     NA
## 2  2     0  15    439      8     26    152
## 3  3     1  19    382     NA     NA     NA
## 4  4     1  12    388     NA     NA     NA
## 5  5     0  17    383    246    253     NA
## 6  6     1  44    364     NA     NA     NA
\end{verbatim}

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{cgd-dataset-2}{%
CGD dataset\ldots}}

The dataset \texttt{cgd} has been transformed to the multi-line per case
format used for correlated failure time data in \textsf{R}.

\footnotesize

\begin{verbatim}
##   id   treat age tstart enum tstop status
## 1  1  rIFN-g  12      0    1   219      1
## 2  1  rIFN-g  12    219    2   373      1
## 3  1  rIFN-g  12    373    3   414      0
## 4  2 placebo  15      0    1     8      1
## 5  2 placebo  15      8    2    26      1
\end{verbatim}

\end{frame}

\begin{frame}{%
\protect\hypertarget{some-simple-summary-statistics}{%
Some simple summary statistics}}

Observed events in placebo group:

\begin{itemize}
\item
  30 out of 65 individuals with at least one event
\item
  56 total infections
\end{itemize}

Observed events in treatment group:

\begin{itemize}
\item
  14 out of 63 individuals with at least one event
\item
  20 total infections
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{modeling-options}{%
Modeling options}}

There are three common approaches to data like these:

\begin{itemize}
\item
  Analyze time to first event, ignoring the subsequent events
\item
  Multiplicative intensity (MI) model, also called the Andersen-Gill
  (AG) model
\item
  Marginal models for the infection times
\item
  Conditional (frailty) models
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{the-multiplicative-intensity-mi-model}{%
The Multiplicative Intensity (MI) model}}

The MI model is a natural consequence of proportional hazards regression
and Poisson regression.

Two approaches available:

\begin{itemize}
\item
  Intuitive ideas based on Poisson process, analysis of binary data
\item
  More formal approach based on martingale theory
\end{itemize}

Simple approach first. Suppose an event may be observed repeatedly in
same subject with continued follow-up.

\begin{itemize}
\item
  CGD data is a good concrete example to keep in mind.
\item
  Let \(N(t)\) be the number of observed events in a given subject by
  time \(t\).
\item
  In the Cox model for failure time data, \(N(t) \leq 1\).
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{the-multiplicative-intensity-mi-model-1}{%
The Multiplicative Intensity (MI) model\ldots}}

If

\begin{itemize}
\item
  \(T\) is time to an event,\\
\item
  \(C\) is potential censoring time, and
\item
  \(\bZ^\prime = (Z_1,\ldots, Z_p)\) is \(p\)-dimensional covariate
  vector,

  \begin{itemize}
  \tightlist
  \item
    For simplicity, assume the covariates are not time-dependent.
  \end{itemize}
\end{itemize}

then \ldots \begin{align*}
\lambda(t \mid \bZ )dt &=  P (t \leq T < t+dt, T \leq C
    \mid \bZ, T \ge t, C \ge t) \\
&= \lambda_0(t) \exp(\bbeta^\prime \bZ).
\end{align*}

\end{frame}

\begin{frame}{%
\protect\hypertarget{counting-processes}{%
Counting processes}}

In the counting process model, \[
    dN(t) = N(t) - N(t-)
\] is a binary variable analogous to \(I(t \leq T < t + dt, T \leq C)\).

Let

\begin{itemize}
\item
  \({\cal F}_t\) represent the `history’ of the observable data over
  \([0,t]\), and
\item
  \(Y(t) = 1\) if subject is at risk for an observable failure at time
  \(t\) and 0 otherwise.
\end{itemize}

It is reasonable to model \[
    \mbox{E} \{dN(t) \mid {\cal F}_{t-}\} = Y(t) \lambda_0 (t)  
        \exp(\bbeta^\prime \bZ) dt.
\]

\end{frame}

\begin{frame}{%
\protect\hypertarget{counting-processes-1}{%
Counting processes\ldots}}

Relationship on previous slide specifies `incremental’ mean for \(N\).

For second moment, let
\(dA(t) = Y(t) \lambda_0 (t) \exp(\bbeta {\bf Z}) dt\). Then
\[  \mbox{Var} \{dN(t) \mid {\cal F}_{t-}\} = 
    dA(t)[1-dA(t)] \approx dA(t). \]

With this specification, \(N(t)\) is Poisson-like with mean and variance
function \(A(t)\).

We can think of the observable data as Poisson-like count data with

\begin{itemize}
\item
  Variable amounts of follow-up per person.
\item
  An event rate that may depend not only on covariates but
  time-dependent functions of the history of the observables. Note that
  dependence is multiplicative with respect to a common baseline rate
  function \(\lambda_0\).
\item
  Possible gap times in the time-at-risk.
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{martingale-specification-of-the-miag-model}{%
Martingale specification of the MI/AG model}}

This approach is due to Andersen \& Gill (1982); discussed in detail in
ABGK (1993) and Fleming \& Harrington (1991).

We only give terminology here:

A process \(M\) is called a martingale with respect to a specification
of history, \({\cal F}_t, t \ge 0\) if

\begin{enumerate}
[1.]
\item
  \(M(t)\) is adapted to \({\cal F}_t\) for each \(t\),
\item
  \(\mbox{E}|M(t)| < \infty\) for all \(t < \infty\), and
\item
  \(\mbox{E}\{M(t+s)|{\cal F}_t\} = M(t)\) a.s. for all
  \(s\geq 0,t\geq 0\).
\end{enumerate}

Condition (3) implies that \(\mbox{E}\{M(t) - M(u)|{\cal F}_u\} = 0\)
for all \(u \le t\),

This is sometimes written informally as
\(\mbox{E}\{dM(t) | {\cal F}_{t-}\} = 0.\)

\end{frame}

\begin{frame}{%
\protect\hypertarget{martingale-approach}{%
Martingale approach}}

A \emph{martingale model} for a counting process \(N(t)\) is a
specification of a time-dependent rate function \(A(t)\), called the
compensator for \(N\), and a history of observables \({\cal F}_t\) such
that \[
    M(t) = N(t) - A(t)
\] is an \({\cal F}_t\)-martingale.

\end{frame}

\begin{frame}{%
\protect\hypertarget{consequences-of-modeling-strategy}{%
Consequences of modeling strategy}}

\begin{itemize}
\item
  Standard partial likelihood methods lead to unbiased and
  asymptotically normal estimators.
\item
  Parameter estimates have simple interpretation.
\item
  Much of technology for standard Cox model (time-dependent covariates,
  diagnostics, etc.) applies here.
\item
  The centered process \(M(t)\) has independent increments, a strong
  assumption about dependence structure. This implies that the
  inter-event times within an individual are independent.
\item
  Requires common baseline hazard within strata, and time origin must be
  chosen carefully.
\end{itemize}

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{fitting-the-ag-model}{%
Fitting the AG model}}

Fitting the AG model in \textsf{R} uses the multi-line
\texttt{t-start, t-stop} form of a survival dataset.

Start with a simple model \footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(survival)}
\KeywordTok{data}\NormalTok{(cgd)}
\KeywordTok{coxph}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(tstart, tstop, status) }\OperatorTok{~}\StringTok{ }\NormalTok{treat }\OperatorTok{+}\StringTok{ }\NormalTok{age }
      \OperatorTok{+}\StringTok{ }\KeywordTok{cluster}\NormalTok{(id), }\DataTypeTok{data=}\NormalTok{cgd)}
\end{Highlighting}
\end{Shaded}

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{fitting-the-ag-model-1}{%
Fitting the AG model}}

\footnotesize

\begin{verbatim}
## Call:
## coxph(formula = Surv(tstart, tstop, status) ~ treat + age + cluster(id), 
##     data = cgd)
## 
##                coef exp(coef) se(coef) robust se     z      p
## treatrIFN-g -1.1201    0.3263   0.2613    0.3099 -3.61 0.0003
## age         -0.0305    0.9699   0.0131    0.0144 -2.11 0.0345
## 
## Likelihood ratio test=25.9  on 2 df, p=2.38e-06
## n= 203, number of events= 76
\end{verbatim}

\end{frame}

\begin{frame}{%
\protect\hypertarget{strengthsweaknesses}{%
Strengths/weaknesses}}

Strength of the model:

\begin{itemize}
\tightlist
\item
  Easy to interpret
\end{itemize}

Weaknesses:

\begin{itemize}
\item
  The estimation procedure assumes that the repeated inter-event times
  are independent.
\item
  Treatment effects are constant across inter-event times.
\end{itemize}

\end{frame}

\begin{frame}{%
\protect\hypertarget{using-the-wlw-approach-with-cgd-data}{%
Using the WLW approach with CGD data}}

The WLW approach with these data assumes

\begin{itemize}
\item
  Event types are the event number (i.e., first event, second event,
  etc.) per person.
\item
  Event types define strata.
\item
  Each failure time for event type is measured from time 0 on the
  original scale.

  \begin{itemize}
  \item
    The waiting time for the second event will be larger than for the
    first event.
  \item
    The waiting time for the third event will be larger than for the
    first and second events.
  \item
    etc \ldots
  \end{itemize}
\end{itemize}

Details for a similar problem in the lab.

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{wlw-with-cgd-data}{%
WLW with CGD data\ldots}}

\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(eventtimedata)}
\KeywordTok{data}\NormalTok{(cgd.wlw)}
\KeywordTok{print}\NormalTok{(cgd.wlw[}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{, }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{13}\OperatorTok{:}\DecValTok{15}\NormalTok{)])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##   id   treat time status enum
## 1  1  rIFN-g  219      1    1
## 2  2 placebo    8      1    1
## 3  3  rIFN-g  382      0    1
## 4  4  rIFN-g  388      0    1
## 5  5 placebo  246      1    1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n =}\StringTok{ }\KeywordTok{length}\NormalTok{(cgd.wlw}\OperatorTok{$}\NormalTok{time)}
\KeywordTok{print}\NormalTok{(cgd.wlw[(n}\DecValTok{-4}\NormalTok{)}\OperatorTok{:}\NormalTok{n, }\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{13}\OperatorTok{:}\DecValTok{15}\NormalTok{)])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        id   treat time status enum
## 124.6 131  rIFN-g  243      0    7
## 125.6 132 placebo  203      0    7
## 126.6 133  rIFN-g  197      0    7
## 127.6 134 placebo  227      0    7
## 128.6 135 placebo  227      0    7
\end{verbatim}

\end{frame}

\begin{frame}[fragile]{%
\protect\hypertarget{wlw-with-cgd-data-1}{%
WLW with CGD data\ldots}}

\footnotesize

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{(survival)}
\KeywordTok{library}\NormalTok{(eventtimedata)}
\KeywordTok{data}\NormalTok{(cgd.wlw)}
\KeywordTok{coxph}\NormalTok{(}\KeywordTok{Surv}\NormalTok{(time, status) }\OperatorTok{~}\StringTok{ }\NormalTok{treat }\OperatorTok{+}\StringTok{ }\NormalTok{age }\OperatorTok{+}\StringTok{ }\KeywordTok{strata}\NormalTok{(enum)}
      \OperatorTok{+}\StringTok{ }\KeywordTok{cluster}\NormalTok{(id), }\DataTypeTok{data =}\NormalTok{ cgd.wlw)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Call:
## coxph(formula = Surv(time, status) ~ treat + age + strata(enum) + 
##     cluster(id), data = cgd.wlw)
## 
##                coef exp(coef) se(coef) robust se     z       p
## treatrIFN-g -1.4144    0.2431   0.2719    0.3674 -3.85 0.00012
## age         -0.0379    0.9628   0.0134    0.0176 -2.15 0.03144
## 
## Likelihood ratio test=37.9  on 2 df, p=5.92e-09
## n= 896, number of events= 76
\end{verbatim}

\end{frame}

\end{document}
