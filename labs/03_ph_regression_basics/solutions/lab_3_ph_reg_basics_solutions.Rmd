---
title: "Lab 3, PH Regression Basics: Solutions"
author: "Dave Harrington"
date: "May 2018"

fontsize: 11pt
geometry: margin=1in
output: pdf_document
---

The lab files come in two versions: a PDF with the problem statements and an Rmd file that produces the PDF. In most cases, you can work in the Rmd file and enter in your solutions. For the purely algebraic questions, you may either use LaTeX commands to enter your solutions in the Rmd file or write out the answers on paper. 

The solution files (a PDF with the solutions, and the Rmd file to produce them) are contained in a separate folder under each lab. Your learning experience with the labs will be more effective if you do not look at the solutions until after you finish working on the questions.

#### MAC Prevention Clinical Trial

ACTG 196 was a randomized clinical trial designed to study the effects of combination regimens on the prevention of MAC (mycobacterium avium complex), one of the common opportunistic infections (OI) in patients with HIV infection.  Patients were enrolled between April 1993 and February 1994, and follow-up ended August 1995.

The treatment regimens were clarithromycin (experimental), rifabutin (standard), and clarithromycin plus rifabutin (experimental combination)

This lab explores possible treatment effects. 

The primary endpoint of the study was the time to  development of MAC, which is associated with significant mortality. Secondary endpoints of the trial were survival, drug toxicity resulting in permanent discontinuation of study drugs, and quality of life as measured by a periodically administered questionnaire.  The three problems in this lab step through some analyses of the trial.  

The analysis of the primary endpoint (time to MAC) should be done with a competing risks analysis, since in this dataset, time to MAC was censored by either administrative censoring (independent censoring) or death (dependent censoring). Since the lectures have not covered the analysis of competing risks, this series of lab exercises examines the effect of treatment and other prognostic variables on time to death.

The data for this problem is in the dataset \texttt{mac}, which is  in the package \texttt{eventtimedata}.  

Be careful about the coding for the treatment.  The coding \texttt{rif = 1} means that rifabutin was being used alone; \texttt{clari = 1} means that clarithromycin was being used alone.  The combination arm (rifabutin and clarithromycin) is denoted by \texttt{rif = 0}, \texttt{clari = 0}. 

\newpage

#### Problem 1:  The effect of treatment on time to death

a) Recode the treatment variables to avoid confusion. Either create three binary variables (one for each treatment arm), or create a single factor variable with three levels. Confirm that the new coding is correct using tables.

b) Explore the distribution of time to death with relevant numerical and graphical summaries, both overall and by treatment. Describe what you see.

c) Using a proportional hazards model, calculate an overall test statistic for differences in time to death among the three treatments, without adjusting for any covariates. Summarize your findings in a brief paragraph.  Be sure to include a statement of what the null and alternative hypotheses are for the test. 

d) Repeat the analysis in part c) using a three sample log-rank test. In this approach, what do the $p$-value and test statistic for differences among the three treatments correspond to in the analysis from part c)?

e) Repeat the analysis in part d), but with two pairwise log-rank tests. How does this approach differ from the one in part c)?

f) What is the estimated survival at 230 days for each of the three treatment groups?

g) Assess the assumption of proportional hazards for the three treatment groups by creating a plot of  $\log[-\log(\widehat{S}(t))]$ versus $\log(t)$ for each of the three treatments.   How should these plots look if the the proportional hazards assumption is approximately correct?




### Problem 1 Solution.

a) See code for defining treatment as a single factor variable. Factor variables are safer in \textsf{R} than the traditional approach of binary dummy variables, since factors are treated properly in regression models and avoid the danger of treating a categorical variable as numeric.

```{r eval=TRUE, echo=TRUE}
library(survival)
library(eventtimedata)
data(mac)

#recode treatment as a factor variable
treatment = rep(1, length(mac$rif))
treatment[mac$clari == 1] = 2
treatment[mac$clari + mac$rif == 0] = 3
mac$treatment = factor(treatment, labels = c("rif", "clari", "clari + rif"))

table(mac$rif, mac$treatment)
```

b) The median time to death in the study population is 712 days, with 95\% confidence interval (678, 762) days.  The confidence band around the survival plot is reasonably narrow, showing that the curve is estmated with good precision.  There is considerable censoring in the right tail, typical of independent administrative censoring.  This censoring causes the confidence band to become wider past 600 days.

    The distributions of time to death for the three treatments are similar, with medians 684 days for the combination arm (clari + rif), 731 days for the clarithromycin alone arm (clari) and 712 for the control arm (rif). 

    The smaller sample size in the separate treatment arms leads to more variability  in the estimates of the median, preventing the estimate of upper confidence limits for the median by treatment group.
    
```{r}
#time to death, overall
time.to.death = survfit(Surv(dthtime, dthstat) ~ 1, data = mac)
print(time.to.death)
plot(time.to.death, mark.time = T,
     xlab = "Days", ylab = "Probability of Survival",
     main = "KM of Survival Probability")

#time to death, by treatment
time.to.death.treat = survfit(Surv(dthtime, dthstat) ~ treatment, 
                              data = mac)
print(time.to.death.treat)
plot(time.to.death.treat, mark.time = T, lty = 1:3, col = 2:4,
     xlab = "Days", ylab = "Probability of Survival",
     main = "KM of Survival Probability")
legend(x = "bottomleft", lty = 1:3, col = 2:4, 
       legend = c("rif", "clari", "clari + rif"))
```


c) Let  $\beta_{\text{combo}},\; \beta_{\text{clari}} \text{ and } \beta_{\text{rif}}$ be the regression coefficients for the three treatment groups. The null and alternative hypotheses for an overall test for treatment differences, using a regression model, are $H_0: \beta_{\text{combo}} = \beta_{\text{clari}} = \beta_{\text{rif}}$ vs. $H_A:$ at least two are not equal. The overall test for a treatment difference among the three groups is given by the likelihood ratio test statistic from the PH regression, which has nonsignificant $p$-value 0.54. There is not significant evidence of a difference in time to death among the three treatment groups.

    Note that as in linear regression, the coefficient for the baseline treatment (the control) does not appear in the output since it is treated as the baseline factor in the regression.  In linear regression, however, the estimate of the baseline coefficient would be the intercept for the regression line.  Since the baseline hazard is not estimated in PH regression, the analogue of the intercept (the baseline  hazard) is not available. The control arm (rifabutin) is treated as the baseline category in the regression because its numerical value (1) is the smallest of the three.

```{r}
#ph regression for differences in time to death by treatment
coxph(Surv(dthtime, dthstat) ~ treatment, data = mac)
```

d) As expected, the three-sample log-rank test is not significant. The test is conceptually the same as the global likelihood ratio test in the PH model. The numerical values are slightly different because of the usual small differences between a LR and (three-sample) Wald statistic.

```{r}
#three-group log-rank test
survdiff(Surv(dthtime, dthstat) ~ treatment, data = mac)
```

e) As expected, the two pairwise log-rank tests are not significant. Unlike the regression approach or the three-sample log-rank, each of the two pairwise tests do not use the full dataset, and may be inefficient.

```{r}
#two-group log-rank, clari vs control (rif)
clari.vs.control = subset(mac, treatment == "rif" | treatment == "clari")
survdiff(Surv(dthtime, dthstat) ~ treatment, data = clari.vs.control)

#two-group log-rank, combo vs control (rif)
combo.vs.control = subset(mac, treatment == "rif" | treatment == "clari + rif")
survdiff(Surv(dthtime, dthstat) ~ treatment, data = combo.vs.control)
```

f) The three estimated survival probabilities at 230 days are 0.91170 (rif), 0.93188 (clari), and 0.91570 (clari + rif).

```{r}
#estimate of survival at 230 days
summary(time.to.death.treat, time = 230)$surv
```

g) If the proportional hazards assumption is approximately correct, then the lines should be approximately linear and parallel.

```{r, fig.height = 3.8}
#log-log plot
plot(time.to.death.treat, mark.time = F, lty = 1:3, col=2:4,
     fun = "cloglog", xlab = "log(t)", ylab = "log(-log(S(t)))")
```

\newpage

####Problem 2: Association of CD4 cell count with time to death

The results from a clinical trial are often informative about prognosis for patients, even when the trial fails to establish a treatment effect.  CD4 (cluster of differentiation 4) is a glycoprotein present on the surface of immune cells.  When the number of CD4 cells in a patient is low, the immune system of the patient is less effective at fighting off infections. In the early days of the HIV epidemic, opportunistic infections in HIV+ patients were a major cause of mortality.  

The CD4 count is a measure of the number of CD4 cells in the body, and is usually measured as the number of CD4 cells per cubic millimeter of blood. The variable \texttt{cd4cat} is coded \texttt{0} for patients with CD4 cell count lower than or equal to 25 cells per mm$^{3}$ of blood, and $\texttt{1}$ for patients with CD4 cell count higher than 25 cells per mm$^3$ of blood.

This problem examines the association of CD4 cell count with time to death. 

a) Produce a plot showing the estimated Kaplan-Meier survival functions for both CD4 $>$ 25 and CD4 $\le$ 25.

b) Calculate a log-rank test of the effect of CD4 category ($>$ 25 vs $\le$ 25)
on the risk of death.  

c) Calculate the generalized Wilcoxon test (Peto and Prentice, Fleming-Harrington test with $\rho = 1$) for the effect of \texttt{cd4cat} on risk of death. How does it compare to the log-rank test? When would you expect it to be less powerful than the log-rank test under the alternative suggested by the data?

d) Fit a Cox proportional hazards model to survival time, with \texttt{cd4cat}
as the only covariate. Provide the Wald, score, and likelihood ratio tests
for the effect of CD4 level on the HR for death. Are any of these test
statistics equivalent to the log-rank or Wilcoxon test statistics from the above calculations?

e) Summarize the effect of CD4 in the model from part d) using the estimated hazard ratio and 95\% confidence interval. Write a short interpretation of the hazard ratio.

Karnofsky score (\texttt{karnof}) is an overall health assessment made by the primary care physician, and has possible values (for this study) of 50, 60, 70, 80, 90
or 100, where 100 represents a lack of any symptoms and a score of 50
indicates impairment in daily function to the point of requiring
considerable assistance and frequent medical care.  

f)  Compare the test statistics for the effect of CD4 category on
the risk of death from the following models. Explain the assumptions behind each approach and differences in interpretation.

    - Score test for \texttt{cd4cat} from Cox PH model, stratifying by Karnofsky score
    - Score test for \texttt{cd4cat} from Cox PH model, controlling for Karnofsky score
    - Log-rank test for \texttt{cd4cat}, stratifying by Karnofsky score

g) The dataset also contains the CD4 cell count as a numeric variable, \texttt{cd4}.  Describe the association between \texttt{cd4} and time to death, and explain how this association compares to the association examined between \texttt{cd4cat} and death in the previous parts of this problem.

\newpage

### Problem 2 Solution.

a) 

```{r}
#time to death, by cd4cat
time.to.death.cd4cat = survfit(Surv(dthtime, dthstat) ~ cd4cat, 
                              data = mac)
plot(time.to.death.cd4cat, mark.time = T, lty = 1:2, col = 3:4,
     xlab = "Days", ylab = "Probability of Survival",
     main = "KM of Survival Probability")
legend(x = "bottomleft", lty = 1:2, col = 3:4, 
       legend = c("low CD4 count", "high CD4 count"))
```

b) The $p$-value is highly significant ($p < 0.0001$); there is evidence that risk of death is lower for individuals with CD4 cell count higher than 25 cells per mm$^3$ of blood.

```{r}
#log-rank test, cd4cat
survdiff(Surv(dthtime, dthstat) ~ cd4cat, data = mac)
```

c) The generalized Wilcoxon test also produces a highly significant $p$-value; this is to be expected since the survival curves are already diverging at small values of $t$. The generalized Wilcoxon emphasizes early differences in the survival curves and will be less powerful than the log-rank test when the survival curves mainly differ at large values of $t$.

```{r}
#generalized wilcoxon test, cd4cat
survdiff(Surv(dthtime, dthstat) ~ cd4cat, rho = 1, data = mac)
```


d) The score test statistic, 50.53, is equivalent to the log-rank test statistic from part b). When there are no tied failure times in a model with two groups, the score test for $\beta = 0$ is the log-rank test.

```{r}
#ph regression for differences in time to death by cd4cat
mac.ph.cd4cat = coxph(Surv(dthtime, dthstat) ~ cd4cat, data = mac)
summary(mac.ph.cd4cat)
```

e) The estimated hazard ratio is 0.535, with confidence interval (0.449, 0.638). The hazard ratio indicates that the death rate for individuals with CD4 cell count higher than 25 is 53.5% of that in the lower category. The data are consistent with a reduction in death rate between 36\% and 52\% for individuals in the high CD4 cell count category. 

f) The stratified log-rank test and stratified PH model provide complementary information; the score statistic (33.45) is highly significant for the effect of CD4 category, as in the previous analysis. The estimated hazard ratio for CD4 category in the two PH models are essentially identical: 0.593 in the stratified model and 0.598 in the adjusted model. The adjusted model assumes that the PH assumption holds for \texttt{karnof} and estimates an effect for Karnofsky score. The stratified model fits a different survival curve for each of the six categories of Karnofsky score, and assumes the same estimated hazard ratio across strata, with a different baseline hazard for each group.

```{r}
#ph regression, cd4cat stratifying by karnof
mac.ph.cd4cat.strat.karnof = coxph(Surv(dthtime, dthstat) ~ cd4cat + 
                                     strata(karnof), data = mac)
summary(mac.ph.cd4cat.strat.karnof)$coeff

#ph regression, cd4cat controlling for karnof
mac.ph.cd4cat.karnof = coxph(Surv(dthtime, dthstat) ~ cd4cat + karnof, 
                          data = mac)
summary(mac.ph.cd4cat.karnof)$coeff

#log-rank test, cd4cat stratifying by karnof
survdiff(Surv(dthtime, dthstat) ~ cd4cat + strata(karnof), dat = mac)$chisq

#log-log plot, assess ph assumption for karnof
plot(survfit(Surv(dthtime, dthstat) ~ karnof, data = mac),
     fun = "cloglog", xlab = "log(t)", ylab = "log(-log(S(t)))", col = 1:6)
```


g) The estimated hazard ratio is 0.988, with confidence interval (0.986, 0.992). A patient with a CD4 cell count of 1 unit higher than another patient, with all covariates equal, will have a death rate 1.2\% lower. This association coheres with the previous findings---an increased number of CD4 cells is associated with lower risk of death---but models the change in risk by actual cell count rather than grouping patients into two categories at a cutoff point.

```{r}
#ph regression, cd4
mac.ph.cd4 = coxph(Surv(dthtime, dthstat) ~ cd4, data = mac)
summary(mac.ph.cd4)$coeff
```


\newpage

#### Problem 3:  Adjusted analyses of treatment and CD4 counts

Fit a Cox PH model to the following variables: \texttt{age}, \texttt{sex}, \texttt{karnof}, \texttt{antiret}, \texttt{cd4cat}, and \texttt{treatment}. 

The \texttt{antiret} variable indicates history of antiretroviral use, with $\texttt{0}$ indicating never/unknown and $\texttt{1}$ indicating previous or current use. 

a) How is the "baseline" group defined in this model, in terms of the covariates? Does the baseline group correspond to any of the observations in the dataset?

b) Do the results from this model change the earlier conclusion about the possible differences among these treatments? Be sure to include both the global test of a treatment effect in this adjusted analysis, as well as the pairwise tests of the two experimental treatments versus the rifabutin control.

c) What is the estimated hazard ratio for death associated with a
higher CD4 count ($> 25$ vs $\le 25$), adjusting for all other
covariates? Give a 95\% confidence interval for the hazard ratio for \texttt{cd4cat}, adjusting for the other covariates, and provide a verbal interpretation of the confidence interval for a non-statistician. How does this compare to the unadjusted effect estimated in Problem 2?

d)  What is the interpretation of the estimated hazard ratio for age? What is the estimated hazard ratio for death for a subject aged 45 years versus a subject aged 30 years, holding all other covariates constant? 

e) Based on this model, calculate the estimated hazard ratio of death for a subject aged 50 with baseline CD4 $\le$ 25 and Karnofsky score of 70 versus a subject aged 30 with baseline CD4 $>$ 25 and Karnofsky score equal of 100.

f) In the early days of the HIV epidemic, it was thought that the prognosis differed between men and women. Based on these data, describe the association of sex with risk of death, using the summary statistics you believe are best suited for this.

g) It was also thought that the response to treatment might differ by sex; that is, that there might be a sex by treatment interaction for the outcome of time to death.  Do these data support that hypothesis, at least with these treatments?  Explain why the main effect for sex appears to be different in the model with the interaction versus the model without the interaction.


\newpage

### Problem 3 Solution.

```{r}
mac.adjusted.ph = coxph(Surv(dthtime, dthstat) ~ age + sex + karnof + antiret
      + cd4cat + treatment, data = mac)
mac.adjusted.ph
```


a) The baseline category consists of male individuals age 0 who have Karnofsky score of 0, no prior history of antiretroviral therapy, CD4 cell count less than 25, who are assigned to the treatment group. There will be no observations in the dataset with these values (since none of the individuals will be age 0 years).

b) Results from this model do not change the earlier conclusion about possible differences among these treatments. There is not significant evidence of an effect of the two experimental treatments versus the rifabutin control; the $p$-values are 0.764 for clarithromycin versus control and 0.838 for combination versus control. The global test for an overall treatment effect is also non-significant; there is virtually no change in the LR statistic between an adjusted model that contains treatment versus one that does not. 

```{r}
#LR statistic, model without treatment
summary(coxph(Surv(dthtime, dthstat) ~ age + sex + karnof + antiret
      + cd4cat, data = mac))$logtest["test"]
#LR statistic, model including treatment
summary(mac.adjusted.ph)$logtest["test"]
```

c) In the adjusted model, the estimated hazard ratio for the variable \texttt{cd4cat} is 0.573; the death rate in the high CD4 cell count category is only 57\% of that in the lower category, a reduction of approximately 43\%. The confidence interval for the hazard ratio is (0.48, 0.69). The data are consistent with a reduction in death rate of between 31\% and 52% for individuals in the high CD4 cell count category ($> 25$) versus low CD4 cell count ($\leq 25$).

    To calculate the confidence interval for the hazard ratio, first calculate a confidence interval for $\widehat{\beta}$, then exponentiate. The confidence interval can also be obtained directly from \textsf{R} using \texttt{summary()}.

    After adjusting for the other variables, the hazard ratio is higher; the estimated hazard ratio from the unadjusted model was 0.535. 
     
```{r}
#hand calculation
cd4cat.coef = -0.55742
cd4cat.se.coef = 0.09124
m = qnorm(0.975)*cd4cat.se.coef
exp(cd4cat.coef - m); exp(cd4cat.coef + m)

#using R directly
summary(mac.adjusted.ph)$conf.int["cd4cat",]
```

d) The hazard ratio for age is 1.02. A patient one year older than another patient, with all other covariates equal, will have a death rate 2\% higher than the younger patient. The estimated hazard ratio for a patient 45 years old versus a patient 30 years old, with all other covariates held constant, is $\exp(0.02161\times15) = 1.38$. 

e) Calculate the difference in the log hazard ratios for the two cases, then exponentiate. The hazard ratio is 2.69.

```{r}
lhr.cd4cat = mac.adjusted.ph$coefficients["cd4cat"]
lhr.age = mac.adjusted.ph$coefficients["age"]

lhr.diff = lhr.cd4cat*(0 - 1) + lhr.age*(50 - 30)
hr = exp(lhr.diff)
hr
```

f) There were 1060 males in this study, and far fewer females, only 117. The early days of the HIV epidemic in the US was largely concentrated in gay men.

    In an unadjusted analysis, the median survival is 712 days for men and 652 days for women. The upper bound for the median survival cannot be estimated in this dataset.

    In the adjusted model, women have an estimated 39\% higher death rate than men. This is consistent with the  unadjusted analysis. The 95\% confidence interval for the hazard ratio implies that the data are consistent with an increase in the death rate for women between 5\% and 85\%.  

```{r}
#summary table
table(mac$sex)

#unadjusted analysis
print(survfit(Surv(dthtime, dthstat) ~ sex, data = mac))

#adjusted analysis
summary(mac.adjusted.ph)$conf.int["sex",]
```

g) The model that includes a sex by treatment interaction does not support the hypothesis that these treatments have different outcomes in men than in women. However, there are very few women in this study, so there is not a great deal of data to explore an interaction.

    In the model with an interaction, the main effect for sex is no longer signficant.  The sex coefficient has changed only a little (0.33 to 0.37), but the standard error for the sex coefficient is substantially larger in the model with the interaction (0.15 vs 0.26). The additional parameters in the interaction model have decreased the precision of the estimates. 

```{r}
coxph(Surv(dthtime, dthstat) ~ age +  karnof + antiret
      + cd4cat + sex*treatment, data = mac)
```

